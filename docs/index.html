<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mechanic Shop - Customer Portal</title>
    <link rel="stylesheet" href="style.css">
        <!-- The rest of your HTML content goes here, outside the <style> block. -->
        <!-- ...existing code... -->
        <script src="index.js"></script>
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function getInventoryById() {
            const resultDiv = document.getElementById('get-inventory-result');
            const inventoryId = document.getElementById('getInventoryId').value;
            
            if (!inventoryId) {
                resultDiv.innerHTML = '<div class="error">Please enter an inventory ID!</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Loading inventory item...</div>';
            
            try {
                const response = await fetch(`${getApiUrl()}/inventory/${inventoryId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const item = await response.json();
                let ticketsHtml = '';
                // Try to find related tickets in the response
                let tickets = [];
                if (item.tickets && Array.isArray(item.tickets)) {
                    tickets = item.tickets;
                } else if (item.service_tickets && Array.isArray(item.service_tickets)) {
                    tickets = item.service_tickets;
                }
                if (tickets.length > 0) {
                    ticketsHtml = `<div style='margin-top:1em;'><b>Used in Tickets:</b><ul style='margin:0 0 0 1em;'>` +
                        tickets.map(t => `<li>Ticket #${t.id}: ${t.description ? t.description : ''}</li>`).join('') +
                        `</ul></div>`;
                }
                resultDiv.style.display = '';
                resultDiv.innerHTML = `
                    <div class="data-card">
                        <h3>${item.name || item.part_name}</h3>
                        <p><b>ID:</b> ${item.id}</p>
                        <p><b>Price:</b> $${item.price}</p>
                        <p><b>Quantity:</b> ${item.quantity}</p>
                        ${item.sku ? `<p><b>SKU:</b> ${item.sku}</p>` : ''}
                        ${item.supplier ? `<p><b>Supplier:</b> ${item.supplier}</p>` : ''}
                        ${item.description ? `<p><b>Description:</b> ${item.description}</p>` : ''}
                        ${ticketsHtml}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function updateInventoryItem() {
            const resultDiv = document.getElementById('update-inventory-result');
            const inventoryId = document.getElementById('updateInventoryId').value;
            const partName = document.getElementById('updateInventoryPartName').value;
            const price = document.getElementById('updateInventoryPrice').value;
            
            if (!inventoryId) {
                resultDiv.innerHTML = '<div class="error">Please enter an inventory ID!</div>';
                return;
            }
            
            const updateData = {};
            if (partName) updateData.name = partName;
            if (price) updateData.price = parseFloat(price);
            
            if (Object.keys(updateData).length === 0) {
                resultDiv.innerHTML = '<div class="error">Please enter at least one field to update!</div>';
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/inventory/${inventoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Inventory item updated!</div>`;
                
                // Clear form
                document.getElementById('updateInventoryId').value = '';
                document.getElementById('updateInventoryPartName').value = '';
                document.getElementById('updateInventoryPrice').value = '';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function deleteInventoryItem() {
            const resultDiv = document.getElementById('delete-inventory-result');
            const inventoryId = document.getElementById('deleteInventoryId').value;
            
            if (!inventoryId) {
                resultDiv.innerHTML = '<div class="error">Please enter an inventory ID!</div>';
                return;
            }
            
            if (!confirm(`Are you sure you want to delete inventory item ${inventoryId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/inventory/${inventoryId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.status === 409) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Cannot delete inventory item!<br>${data.error || 'Item is associated with service tickets.'}<br><br>üí° Tip: Remove this part from service tickets first.</div>`;
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Inventory item deleted!</div>`;
                document.getElementById('deleteInventoryId').value = '';
                
                // Refresh inventory list
                setTimeout(() => refreshInventory(), 500);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Additional Service Ticket Functions
        async function createServiceTicket() {
            const resultDiv = document.getElementById('create-ticket-result');
            const customerId = document.getElementById('ticketCustomerId').value;
            const description = document.getElementById('ticketDescription').value;
            const vehicleYear = document.getElementById('ticketVehicleYear').value;
            const vehicleMake = document.getElementById('ticketVehicleMake').value;
            const vehicleModel = document.getElementById('ticketVehicleModel').value;
            const vehicleVin = document.getElementById('ticketVehicleVin').value;
            const mechanicId = document.getElementById('ticketMechanicId') ? document.getElementById('ticketMechanicId').value : '';
            const estimatedCost = document.getElementById('ticketEstimatedCost').value;
            const status = document.getElementById('ticketStatus').value;
            
            if (!customerId || !description) {
                resultDiv.innerHTML = '<div class="error">Please enter customer ID and description!</div>';
                return;
            }
            
            const ticketData = {
                customer_id: parseInt(customerId),
                description: description,
                status: status
            };
            
            if (vehicleYear) ticketData.vehicle_year = parseInt(vehicleYear);
            if (vehicleMake) ticketData.vehicle_make = vehicleMake;
            if (vehicleModel) ticketData.vehicle_model = vehicleModel;
            if (vehicleVin) ticketData.vehicle_vin = vehicleVin;
            if (mechanicId) ticketData.mechanic_id = parseInt(mechanicId);
            if (estimatedCost) ticketData.estimated_cost = parseFloat(estimatedCost);
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ticketData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                resultDiv.innerHTML = `<div class="success">‚úÖ Service ticket created! ID: ${data.id}</div>`;
                
                // Clear form
                document.getElementById('ticketCustomerId').value = '';
                document.getElementById('ticketDescription').value = '';
                document.getElementById('ticketVehicleYear').value = '';
                document.getElementById('ticketVehicleMake').value = '';
                document.getElementById('ticketVehicleModel').value = '';
                document.getElementById('ticketVehicleVin').value = '';
                document.getElementById('ticketEstimatedCost').value = '';
                document.getElementById('ticketStatus').value = 'Open';
                
                // Refresh ticket list
                setTimeout(() => refreshTickets(), 500);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function getTicketById() {
            const resultDiv = document.getElementById('get-ticket-result');
            const ticketId = document.getElementById('getTicketId').value;
            
            if (!ticketId) {
                resultDiv.innerHTML = '<div class="error">Please enter a ticket ID!</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Loading ticket...</div>';
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/${ticketId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const ticket = await response.json();
                const vehicleInfo = ticket.vehicle_year || ticket.vehicle_make || ticket.vehicle_model
                    ? `${ticket.vehicle_year || ''} ${ticket.vehicle_make || ''} ${ticket.vehicle_model || ''}`.trim()
                    : 'Not specified';
                const customerName = ticket.customer 
                    ? `${ticket.customer.first_name} ${ticket.customer.last_name}`
                    : `Customer ID: ${ticket.customer_id}`;
                const mechanicsList = ticket.mechanics && ticket.mechanics.length > 0
                    ? ticket.mechanics.map(m => `${m.first_name} ${m.last_name}`).join(', ')
                    : 'Not assigned';
                // Parts rendering
                let partsHtml = '';
                if (ticket.parts && Array.isArray(ticket.parts) && ticket.parts.length > 0) {
                    partsHtml = `<p><b>Parts:</b> ` + ticket.parts.map(p => `${p.name || p.part_name || 'Part'} (ID: ${p.id}${p.quantity ? ', Qty: ' + p.quantity : ''})`).join(', ') + `</p>`;
                } else if (ticket.inventory && Array.isArray(ticket.inventory) && ticket.inventory.length > 0) {
                    partsHtml = `<p><b>Parts:</b> ` + ticket.inventory.map(p => `${p.name || p.part_name || 'Part'} (ID: ${p.id}${p.quantity ? ', Qty: ' + p.quantity : ''})`).join(', ') + `</p>`;
                }
                resultDiv.style.display = '';
                resultDiv.innerHTML = `
                    <div class="data-card">
                        <h3>Ticket #${ticket.id}</h3>
                        <p><b>Vehicle:</b> ${vehicleInfo}</p>
                        ${ticket.vehicle_vin ? `<p><b>VIN:</b> ${ticket.vehicle_vin}</p>` : ''}
                        <p><b>Description:</b> ${ticket.description}</p>
                        <p><b>Status:</b> ${ticket.status || 'Open'}</p>
                        <p><b>Customer:</b> ${customerName}</p>
                        <p><b>Mechanic(s):</b> ${mechanicsList}</p>
                        ${partsHtml}
                        ${ticket.estimated_cost ? `<p><b>Estimated Cost:</b> $${ticket.estimated_cost.toFixed(2)}</p>` : ''}
                        ${ticket.actual_cost ? `<p><b>Actual Cost:</b> $${ticket.actual_cost.toFixed(2)}</p>` : ''}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function updateServiceTicket() {
            const resultDiv = document.getElementById('update-ticket-result');
            const ticketId = document.getElementById('updateTicketId').value;
            const description = document.getElementById('updateTicketDescription').value;
            const actualCost = document.getElementById('updateTicketActualCost').value;
            const status = document.getElementById('updateTicketStatus').value;
            const vehicleYear = document.getElementById('updateTicketVehicleYear').value;
            const vehicleMake = document.getElementById('updateTicketVehicleMake').value;
            const vehicleModel = document.getElementById('updateTicketVehicleModel').value;
            const vehicleVin = document.getElementById('updateTicketVehicleVin').value;
            const estimatedCost = document.getElementById('updateTicketEstimatedCost').value;
            
            if (!ticketId) {
                resultDiv.innerHTML = '<div class="error">Please enter a ticket ID!</div>';
                return;
            }
            
            const updateData = {};
            if (description) updateData.description = description;
            if (actualCost) updateData.actual_cost = parseFloat(actualCost);
            if (status) updateData.status = status;
            if (vehicleYear) updateData.vehicle_year = parseInt(vehicleYear);
            if (vehicleMake) updateData.vehicle_make = vehicleMake;
            if (vehicleModel) updateData.vehicle_model = vehicleModel;
            if (vehicleVin) updateData.vehicle_vin = vehicleVin;
            if (estimatedCost) updateData.estimated_cost = parseFloat(estimatedCost);
            
            if (Object.keys(updateData).length === 0) {
                resultDiv.innerHTML = '<div class="error">Please enter at least one field to update!</div>';
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/${ticketId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Service ticket updated!</div>`;
                
                // Clear form
                document.getElementById('updateTicketId').value = '';
                document.getElementById('updateTicketDescription').value = '';
                document.getElementById('updateTicketActualCost').value = '';
                document.getElementById('updateTicketStatus').value = '';
                document.getElementById('updateTicketVehicleYear').value = '';
                document.getElementById('updateTicketVehicleMake').value = '';
                document.getElementById('updateTicketVehicleModel').value = '';
                document.getElementById('updateTicketVehicleVin').value = '';
                document.getElementById('updateTicketEstimatedCost').value = '';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function deleteServiceTicket() {
            const resultDiv = document.getElementById('delete-ticket-result');
            const ticketId = document.getElementById('deleteTicketId').value;
            
            if (!ticketId) {
                resultDiv.innerHTML = '<div class="error">Please enter a ticket ID!</div>';
                return;
            }
            
            if (!confirm(`Are you sure you want to delete service ticket ${ticketId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/${ticketId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Service ticket deleted!</div>`;
                document.getElementById('deleteTicketId').value = '';
                
                // Refresh ticket list
                setTimeout(() => refreshTickets(), 500);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function assignMechanicToTicket() {
            const resultDiv = document.getElementById('assign-mechanic-result');
            const ticketId = document.getElementById('assignTicketId').value;
            const mechanicId = document.getElementById('assignMechanicId').value;
            
            if (!ticketId || !mechanicId) {
                resultDiv.innerHTML = '<div class="error">Please enter both ticket ID and mechanic ID!</div>';
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/${ticketId}/assign-mechanic/${mechanicId}`, {
                    method: 'PUT'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Mechanic assigned to ticket!</div>`;
                
                // Clear form
                document.getElementById('assignTicketId').value = '';
                document.getElementById('assignMechanicId').value = '';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function removeMechanicFromTicket() {
            const resultDiv = document.getElementById('remove-mechanic-result');
            const ticketId = document.getElementById('removeMechanicTicketId').value;
            const mechanicId = document.getElementById('removeMechanicId').value;
            
            if (!ticketId || !mechanicId) {
                resultDiv.innerHTML = '<div class="error">Please enter both ticket ID and mechanic ID!</div>';
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/${ticketId}/remove-mechanic/${mechanicId}`, {
                    method: 'PUT'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Mechanic removed from ticket!</div>`;
                
                // Clear form
                document.getElementById('removeMechanicTicketId').value = '';
                document.getElementById('removeMechanicId').value = '';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function getTicketsByCustomer() {
            const resultDiv = document.getElementById('tickets-by-customer-result');
            const customerId = document.getElementById('ticketsByCustomerId').value;
            
            if (!customerId) {
                resultDiv.innerHTML = '<div class="error">Please enter a customer ID!</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Loading customer tickets...</div>';
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/customer/${customerId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.length === 0) {
                    resultDiv.innerHTML = '<p>No tickets found for this customer.</p>';
                    return;
                }
                
                let html = '';
                data.forEach(ticket => {
                    const vehicleInfo = ticket.vehicle_year || ticket.vehicle_make || ticket.vehicle_model
                        ? `${ticket.vehicle_year || ''} ${ticket.vehicle_make || ''} ${ticket.vehicle_model || ''}`.trim()
                        : 'Not specified';
                    
                    html += `
                        <div class="data-card">
                            <h3>Ticket #${ticket.id}</h3>
                            <p><b>Vehicle:</b> ${vehicleInfo}</p>
                            <p><b>Description:</b> ${ticket.description}</p>
                            <p><b>Status:</b> ${ticket.status || 'Open'}</p>
                            ${ticket.estimated_cost ? `<p><b>Estimated Cost:</b> $${ticket.estimated_cost.toFixed(2)}</p>` : ''}
                        </div>
                    `;
                });
                
                resultDiv.style.display = '';
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function getTicketsByMechanic() {
            const resultDiv = document.getElementById('tickets-by-mechanic-result');
            const mechanicId = document.getElementById('ticketsByMechanicId').value;
            
            if (!mechanicId) {
                resultDiv.innerHTML = '<div class="error">Please enter a mechanic ID!</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Loading mechanic tickets...</div>';
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/mechanic/${mechanicId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.length === 0) {
                    resultDiv.innerHTML = '<p>No tickets found for this mechanic.</p>';
                    return;
                }
                
                let html = '';
                data.forEach(ticket => {
                    const vehicleInfo = ticket.vehicle_year || ticket.vehicle_make || ticket.vehicle_model
                        ? `${ticket.vehicle_year || ''} ${ticket.vehicle_make || ''} ${ticket.vehicle_model || ''}`.trim()
                        : 'Not specified';
                    
                    const customerName = ticket.customer 
                        ? `${ticket.customer.first_name} ${ticket.customer.last_name}`
                        : `Customer ID: ${ticket.customer_id}`;
                    
                    html += `
                        <div class="data-card">
                            <h3>Ticket #${ticket.id}</h3>
                            <p><b>Customer:</b> ${customerName}</p>
                            <p><b>Vehicle:</b> ${vehicleInfo}</p>
                            <p><b>Description:</b> ${ticket.description}</p>
                            <p><b>Status:</b> ${ticket.status || 'Open'}</p>
                            ${ticket.estimated_cost ? `<p><b>Estimated Cost:</b> $${ticket.estimated_cost.toFixed(2)}</p>` : ''}
                        </div>
                    `;
                });
                
                resultDiv.style.display = '';
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Initialize
        updateAuthStatus();
    </script>
</body>
</html>

