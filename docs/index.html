<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mechanic Shop - Customer Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 2rem;
            overflow-x: hidden;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        .section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 500;
            font-size: 1rem;
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        button {
            background: #667eea;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            min-height: 44px; /* Touch-friendly */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .refresh-btn {
            float: right;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }

        .results {
            margin-top: 1.5rem;
            padding: 1rem;
            background: white;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }

        .data-card {
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-card h3 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .data-card p {
            color: #666;
            font-size: 0.9rem;
            margin: 0.25rem 0;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #efe;
            color: #3c3;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            border: 1px solid #c3e6cb;
        }

        .loading {
            text-align: center;
            color: #667eea;
            padding: 2rem;
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab {
            padding: 0.75rem 1rem;
            background: #e0e0e0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            min-height: 44px;
            flex: 1;
            min-width: 120px;
            max-width: 200px;
        }

        .tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .tab:hover {
            background: #d0d0d0;
        }

        .tab.active:hover {
            background: #5568d3;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .auth-required {
            display: none;
        }

        .auth-required.logged-in {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                max-width: 95vw;
                padding: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }
            
            .container {
                max-width: 100vw;
                padding: 1rem;
                border-radius: 0;
                box-shadow: none;
            }
            
            h1 {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }
            
            .section {
                margin-bottom: 1.5rem;
                padding: 1rem;
            }
            
            .section h2 {
                font-size: 1.2rem;
                margin-bottom: 0.75rem;
            }
            
            .tabs {
                gap: 0.25rem;
                margin-bottom: 1.5rem;
            }
            
            .tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.9rem;
                min-width: 100px;
                max-width: none;
                flex: 1 1 auto;
            }
            
            .form-group {
                margin-bottom: 0.75rem;
            }
            
            label {
                font-size: 0.9rem;
            }
            
            input, select, button {
                font-size: 0.9rem;
                padding: 0.625rem;
            }
            
            button {
                padding: 0.625rem 1rem;
                min-height: 40px;
            }
            
            .refresh-btn {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
                margin-bottom: 0.5rem;
            }
            
            .results {
                padding: 0.75rem;
                max-height: 300px;
            }
            
            .data-card {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            .data-card h3 {
                font-size: 1rem;
            }
            
            .data-card p {
                font-size: 0.85rem;
            }
            
            .loading {
                padding: 1.5rem;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0.5rem;
            }
            
            h1 {
                font-size: 1.3rem;
            }
            
            .section {
                padding: 0.75rem;
            }
            
            .tabs {
                flex-direction: column;
                align-items: stretch;
            }
            
            .tab {
                font-size: 0.85rem;
                padding: 0.5rem;
                min-height: 36px;
            }
            
            input, select, button {
                font-size: 0.85rem;
                padding: 0.5rem;
            }
            
            button {
                min-height: 36px;
            }
            
            .data-card {
                padding: 0.5rem;
            }
            
            .results {
                max-height: 250px;
            }
        }

        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .data-card {
                border-left-width: 3px;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
            }
            
            .tabs, button, input, select {
                display: none !important;
            }
            
            .results {
                max-height: none;
                overflow: visible;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Mechanic Shop API Demo</h1>
        <div id="auth-status" style="text-align: center; margin-bottom: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
            <span id="auth-message">üîì Not logged in</span>
        </div>
        
        <div class="tabs">
            <button class="tab" onclick="switchTab('auth')">üîê Login</button>
            <button class="tab active" onclick="switchTab('customers')">üë• Customers</button>
            <button class="tab" onclick="switchTab('mechanics')">üîß Mechanics</button>
            <button class="tab" onclick="switchTab('inventory')">üì¶ Inventory</button>
            <button class="tab" onclick="switchTab('tickets')">üé´ Service Tickets</button>
        </div>
        
        <!-- Authentication Tab -->
        <div id="auth-tab" class="tab-content">
            <div class="section">
                <h2>üîê Customer Login</h2>
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" placeholder="Enter password">
                </div>
                <button onclick="login()">Login</button>
                <button onclick="logout()" style="background: #999; margin-left: 10px;">Logout</button>
                <div id="login-result"></div>
            </div>
            
            <div class="section auth-required" id="my-tickets-section">
                <h2>üé´ My Service Tickets</h2>
                <button onclick="getMyTickets()">Get My Tickets</button>
                <div id="my-tickets-list" class="results" style="display: none;"></div>
            </div>
            
            <div class="section auth-required" id="update-customer-section">
                <h2>‚úèÔ∏è Update My Profile</h2>
                <div class="form-group">
                    <label for="updateCustomerId">Customer ID:</label>
                    <input type="number" id="updateCustomerId" placeholder="1">
                </div>
                <div class="form-group">
                    <label for="updateCustomerFirstName">First Name (optional):</label>
                    <input type="text" id="updateCustomerFirstName" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateCustomerLastName">Last Name (optional):</label>
                    <input type="text" id="updateCustomerLastName" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateCustomerEmail">Email (optional):</label>
                    <input type="email" id="updateCustomerEmail" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateCustomerPassword">Password (optional):</label>
                    <input type="password" id="updateCustomerPassword" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateCustomerPhone">Phone (optional):</label>
                    <input type="tel" id="updateCustomerPhone" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateCustomerAddress">Address (optional):</label>
                    <input type="text" id="updateCustomerAddress" placeholder="Leave blank to keep current">
                </div>
                <button onclick="updateCustomer()">Update Customer</button>
                <div id="update-customer-result"></div>
            </div>
            
            <div class="section auth-required" id="delete-customer-section">
                <h2>üóëÔ∏è Delete My Account</h2>
                <div class="form-group">
                    <label for="deleteCustomerId">Customer ID:</label>
                    <input type="number" id="deleteCustomerId" placeholder="1">
                </div>
                <button onclick="deleteCustomer()" style="background: #c33;">Delete Customer</button>
                <div id="delete-customer-result"></div>
            </div>
        </div>
        
        <!-- Customers Tab -->
        <div id="customers-tab" class="tab-content active">
            <div class="section">
                <h2>View All Customers</h2>
                <button id="toggle-customers-btn" onclick="toggleCustomersList()">Get All Customers</button>
                <div id="customers-list" class="results" style="display: none;"></div>
            </div>
            
            <div class="section">
                <h2>Add New Customer</h2>
                <div class="form-group">
                    <label for="customerFirstName">First Name:</label>
                    <input type="text" id="customerFirstName" placeholder="John">
                </div>
                <div class="form-group">
                    <label for="customerLastName">Last Name:</label>
                    <input type="text" id="customerLastName" placeholder="Doe">
                </div>
                <div class="form-group">
                    <label for="customerEmail">Email:</label>
                    <input type="email" id="customerEmail" placeholder="john@example.com">
                </div>
                <div class="form-group">
                    <label for="customerPassword">Password:</label>
                    <input type="password" id="customerPassword" placeholder="Enter password">
                </div>
                <div class="form-group">
                    <label for="customerPhone">Phone (optional):</label>
                    <input type="tel" id="customerPhone" placeholder="555-1234">
                </div>
                <div class="form-group">
                    <label for="customerAddress">Address (optional):</label>
                    <input type="text" id="customerAddress" placeholder="123 Main St">
                </div>
                <button onclick="addCustomer()">Add Customer</button>
                <div id="add-customer-result"></div>
            </div>
            
            <div class="section">
                <h2>Get Customer by ID</h2>
                <div class="form-group">
                    <label for="getCustomerId">Customer ID:</label>
                    <input type="number" id="getCustomerId" placeholder="1">
                </div>
                <button onclick="getCustomerById()">Get Customer</button>
                <div id="get-customer-result" class="results"></div>
            </div>
            

        </div>
        
        <!-- Mechanics Tab -->
        <div id="mechanics-tab" class="tab-content">
            <div class="section">
                <h2>View All Mechanics</h2>
                <button id="toggle-mechanics-btn" onclick="toggleMechanicsList()">Get All Mechanics</button>
                <div id="mechanics-list" class="results" style="display: none;"></div>
            </div>
            
            <div class="section">
                <h2>Add New Mechanic</h2>
                <div class="form-group">
                    <label for="mechanicFirstName">First Name:</label>
                    <input type="text" id="mechanicFirstName" placeholder="Mike">
                </div>
                <div class="form-group">
                    <label for="mechanicLastName">Last Name:</label>
                    <input type="text" id="mechanicLastName" placeholder="Smith">
                </div>
                <div class="form-group">
                    <label for="mechanicEmail">Email:</label>
                    <input type="email" id="mechanicEmail" placeholder="mike@mechanic.com">
                </div>
                <div class="form-group">
                    <label for="mechanicPhone">Phone (optional):</label>
                    <input type="tel" id="mechanicPhone" placeholder="555-5678">
                </div>
                <div class="form-group">
                    <label for="mechanicSpecialty">Specialty (optional):</label>
                    <input type="text" id="mechanicSpecialty" placeholder="Engine Repair">
                </div>
                <div class="form-group">
                    <label for="mechanicHourlyRate">Hourly Rate (optional):</label>
                    <input type="number" step="0.01" id="mechanicHourlyRate" placeholder="85.00">
                </div>
                <div class="form-group">
                    <label for="mechanicHireDate">Hire Date (optional):</label>
                    <input type="date" id="mechanicHireDate" placeholder="2024-01-15">
                </div>
                <button onclick="addMechanic()">Add Mechanic</button>
                <div id="add-mechanic-result"></div>
            </div>
            
            <div class="section">
                <h2>Get Mechanic by ID</h2>
                <div class="form-group">
                    <label for="getMechanicId">Mechanic ID:</label>
                    <input type="number" id="getMechanicId" placeholder="1">
                </div>
                <button onclick="getMechanicById()">Get Mechanic</button>
                <div id="get-mechanic-result" class="results"></div>
            </div>
            
            <div class="section">
                <h2>Update Mechanic</h2>
                <div class="form-group">
                    <label for="updateMechanicId">Mechanic ID:</label>
                    <input type="number" id="updateMechanicId" placeholder="1">
                </div>
                <div class="form-group">
                    <label for="updateMechanicFirstName">First Name (optional):</label>
                    <input type="text" id="updateMechanicFirstName" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateMechanicLastName">Last Name (optional):</label>
                    <input type="text" id="updateMechanicLastName" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateMechanicEmail">Email (optional):</label>
                    <input type="email" id="updateMechanicEmail" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateMechanicPhone">Phone (optional):</label>
                    <input type="tel" id="updateMechanicPhone" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateMechanicSpecialty">Specialty (optional):</label>
                    <input type="text" id="updateMechanicSpecialty" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateMechanicHourlyRate">Hourly Rate (optional):</label>
                    <input type="number" step="0.01" id="updateMechanicHourlyRate" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateMechanicHireDate">Hire Date (optional):</label>
                    <input type="date" id="updateMechanicHireDate" placeholder="Leave blank to keep current">
                </div>
                <button onclick="updateMechanic()">Update Mechanic</button>
                <div id="update-mechanic-result"></div>
            </div>
            
            <div class="section">
                <h2>Delete Mechanic</h2>
                <div class="form-group">
                    <label for="deleteMechanicId">Mechanic ID:</label>
                    <input type="number" id="deleteMechanicId" placeholder="1">
                </div>
                <button onclick="deleteMechanic()" style="background: #c33;">Delete Mechanic</button>
                <div id="delete-mechanic-result"></div>
            </div>
        </div>
        
        <!-- Inventory Tab -->
        <div id="inventory-tab" class="tab-content">
            <div class="section">
                <h2>View Inventory</h2>
                <button id="toggle-inventory-btn" onclick="toggleInventoryList()">Get All Items</button>
                <div id="inventory-list" class="results" style="display: none;"></div>
            </div>
            
            <div class="section">
                <h2>Add Inventory Item</h2>
                <div class="form-group">
                    <label for="inventoryPartName">Part Name:</label>
                    <input type="text" id="inventoryPartName" placeholder="Oil Filter">
                </div>
                <div class="form-group">
                    <label for="inventoryPrice">Price:</label>
                    <input type="number" step="0.01" id="inventoryPrice" placeholder="15.99">
                </div>
                <button onclick="addInventoryItem()">Add Item</button>
                <div id="add-inventory-result"></div>
            </div>
            
            <div class="section">
                <h2>Get Inventory Item by ID</h2>
                <div class="form-group">
                    <label for="getInventoryId">Inventory ID:</label>
                    <input type="number" id="getInventoryId" placeholder="1">
                </div>
                <button onclick="getInventoryById()">Get Item</button>
                <div id="get-inventory-result" class="results"></div>
            </div>
            
            <div class="section">
                <h2>Update Inventory Item</h2>
                <div class="form-group">
                    <label for="updateInventoryId">Inventory ID:</label>
                    <input type="number" id="updateInventoryId" placeholder="1">
                </div>
                <div class="form-group">
                    <label for="updateInventoryPartName">Part Name (optional):</label>
                    <input type="text" id="updateInventoryPartName" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateInventoryPrice">Price (optional):</label>
                    <input type="number" step="0.01" id="updateInventoryPrice" placeholder="Leave blank to keep current">
                </div>
                <button onclick="updateInventoryItem()">Update Item</button>
                <div id="update-inventory-result"></div>
            </div>
            
            <div class="section">
                <h2>Delete Inventory Item</h2>
                <div class="form-group">
                    <label for="deleteInventoryId">Inventory ID:</label>
                    <input type="number" id="deleteInventoryId" placeholder="1">
                </div>
                <button onclick="deleteInventoryItem()" style="background: #c33;">Delete Item</button>
                <div id="delete-inventory-result"></div>
            </div>
        </div>
        
        <!-- Service Tickets Tab -->
        <div id="tickets-tab" class="tab-content">
            <div class="section">
                <h2>View Service Tickets</h2>
                <button id="toggle-tickets-btn" onclick="toggleTicketsList()">Get All Tickets</button>
                <div id="tickets-list" class="results" style="display: none;"></div>
            </div>

            <div class="section">
                <h2>Add Part to Service Ticket</h2>
                <div class="form-group">
                    <label for="addPartTicketId">Ticket ID:</label>
                    <input type="number" id="addPartTicketId" placeholder="Ticket ID">
                </div>
                <div class="form-group">
                    <label for="addPartInventoryId">Part (Inventory) ID:</label>
                    <input type="number" id="addPartInventoryId" placeholder="Inventory ID">
                </div>
                <button onclick="addPartToTicket()">Add Part to Ticket</button>
                <div id="add-part-to-ticket-result"></div>
            </div>

            <div class="section">
                <h2>Remove Part from Service Ticket</h2>
                <div class="form-group">
                    <label for="removePartTicketId">Ticket ID:</label>
                    <input type="number" id="removePartTicketId" placeholder="Ticket ID">
                </div>
                <div class="form-group">
                    <label for="removePartInventoryId">Part (Inventory) ID:</label>
                    <input type="number" id="removePartInventoryId" placeholder="Inventory ID">
                </div>
                <button onclick="removePartFromTicket()">Remove Part from Ticket</button>
                <div id="remove-part-from-ticket-result"></div>
            </div>

            <div class="section">
                <h2>Get Tickets by Customer ID</h2>
                <div class="form-group">
                    <label for="ticketsByCustomerId">Customer ID:</label>
                    <input type="number" id="ticketsByCustomerId" placeholder="Customer ID">
                </div>
                <button onclick="getTicketsByCustomer()">Get Customer Tickets</button>
                <div id="tickets-by-customer-result" class="results"></div>
            </div>
            
            <div class="section">
                <h2>Create Service Ticket</h2>
                <div class="form-group">
                    <label for="ticketCustomerId">Customer ID:</label>
                    <input type="number" id="ticketCustomerId" placeholder="1">
                </div>
                <div class="form-group">
                    <label for="ticketDescription">Description:</label>
                    <input type="text" id="ticketDescription" placeholder="Oil change and brake inspection">
                </div>
                <div class="form-group">
                    <label for="ticketVehicleYear">Vehicle Year (optional):</label>
                    <input type="number" id="ticketVehicleYear" placeholder="2020">
                </div>
                <div class="form-group">
                    <label for="ticketVehicleMake">Vehicle Make (optional):</label>
                    <input type="text" id="ticketVehicleMake" placeholder="Toyota">
                </div>
                <div class="form-group">
                    <label for="ticketVehicleModel">Vehicle Model (optional):</label>
                    <input type="text" id="ticketVehicleModel" placeholder="Camry">
                </div>
                <div class="form-group">
                    <label for="ticketVehicleVin">Vehicle VIN (optional):</label>
                    <input type="text" id="ticketVehicleVin" placeholder="1HGBH41JXMN109186">
                </div>
                <div class="form-group">
                    <label for="ticketMechanicId">Assign Mechanic (optional):</label>
                    <input type="number" id="ticketMechanicId" placeholder="Mechanic ID">
                </div>
                <div class="form-group">
                    <label for="ticketEstimatedCost">Estimated Cost (optional):</label>
                    <input type="number" step="0.01" id="ticketEstimatedCost" placeholder="150.00">
                </div>
                <div class="form-group">
                    <label for="ticketStatus">Status:</label>
                    <select id="ticketStatus">
                        <option value="Open">Open</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                <button onclick="createServiceTicket()">Create Ticket</button>
                <div id="create-ticket-result"></div>
            </div>
            
            <div class="section">
                <h2>Get Ticket by Service Ticket ID</h2>
                <div class="form-group">
                    <label for="getTicketId">Ticket ID:</label>
                    <input type="number" id="getTicketId" placeholder="1">
                </div>
                <button onclick="getTicketById()">Get Ticket</button>
                <div id="get-ticket-result" class="results"></div>
            </div>
            
            <div class="section">
                <h2>Update Service Ticket</h2>
                <div class="form-group">
                    <label for="updateTicketId">Ticket ID:</label>
                    <input type="number" id="updateTicketId" placeholder="1">
                </div>
                <div class="form-group">
                    <label for="updateTicketDescription">Description (optional):</label>
                    <input type="text" id="updateTicketDescription" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateTicketVehicleYear">Vehicle Year (optional):</label>
                    <input type="number" id="updateTicketVehicleYear" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateTicketVehicleMake">Vehicle Make (optional):</label>
                    <input type="text" id="updateTicketVehicleMake" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateTicketVehicleModel">Vehicle Model (optional):</label>
                    <input type="text" id="updateTicketVehicleModel" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateTicketVehicleVin">Vehicle VIN (optional):</label>
                    <input type="text" id="updateTicketVehicleVin" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateTicketEstimatedCost">Estimated Cost (optional):</label>
                    <input type="number" step="0.01" id="updateTicketEstimatedCost" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateTicketActualCost">Actual Cost (optional):</label>
                    <input type="number" step="0.01" id="updateTicketActualCost" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="updateTicketStatus">Status (optional):</label>
                    <select id="updateTicketStatus">
                        <option value="">-- Keep Current --</option>
                        <option value="Open">Open</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                <button onclick="updateServiceTicket()">Update Ticket</button>
                <div id="update-ticket-result"></div>
            </div>
            
            <div class="section">
                <h2>Delete Service Ticket</h2>
                <div class="form-group">
                    <label for="deleteTicketId">Ticket ID:</label>
                    <input type="number" id="deleteTicketId" placeholder="1">
                </div>
                <button onclick="deleteServiceTicket()" style="background: #c33;">Delete Ticket</button>
                <div id="delete-ticket-result"></div>
            </div>
            
            <div class="section">
                <h2>Assign Mechanic to Ticket</h2>
                <div class="form-group">
                    <label for="assignTicketId">Ticket ID:</label>
                    <input type="number" id="assignTicketId" placeholder="1">
                </div>
                <div class="form-group">
                    <label for="assignMechanicId">Mechanic ID:</label>
                    <input type="number" id="assignMechanicId" placeholder="1">
                </div>
                <button onclick="assignMechanicToTicket()">Assign Mechanic</button>
                <div id="assign-mechanic-result"></div>
            </div>
            
            <div class="section">
                <h2>Remove Mechanic from Ticket</h2>
                <div class="form-group">
                    <label for="removeMechanicTicketId">Ticket ID:</label>
                    <input type="number" id="removeMechanicTicketId" placeholder="1">
                </div>
                <div class="form-group">
                    <label for="removeMechanicId">Mechanic ID:</label>
                    <input type="number" id="removeMechanicId" placeholder="1">
                </div>
                <button onclick="removeMechanicFromTicket()">Remove Mechanic</button>
                <div id="remove-mechanic-result"></div>
            </div>
            
            <div class="section">
                <h2>Get Tickets by Mechanic ID</h2>
                <div class="form-group">
                    <label for="ticketsByMechanicId">Mechanic ID:</label>
                    <input type="number" id="ticketsByMechanicId" placeholder="1">
                </div>
                <button onclick="getTicketsByMechanic()">Get Mechanic Tickets</button>
                <div id="tickets-by-mechanic-result" class="results"></div>
            </div>
        </div>
    </div>

    <script>
                        // Remove part from service ticket
                        async function removePartFromTicket() {
                            const resultDiv = document.getElementById('remove-part-from-ticket-result');
                            const ticketId = document.getElementById('removePartTicketId').value;
                            const partId = document.getElementById('removePartInventoryId').value;
                            if (!ticketId || !partId) {
                                resultDiv.innerHTML = '<div class="error">Please enter both Ticket ID and Part ID!';
                                return;
                            }
                            resultDiv.innerHTML = '<div class="loading">Removing part from ticket...';
                            try {
                                    const response = await fetch(`${getApiUrl()}/service-tickets/${ticketId}/remove-part/${partId}`, {
                                        method: 'PUT'
                                    });
                                    if (!response.ok) {
                                        throw new Error(`HTTP error! status: ${response.status}`);
                                    }
                                    const data = await response.json();
                                    console.log('removePart response:', data);
                                    resultDiv.innerHTML = `<div class="success">‚úÖ Part removed from ticket!</div>`;
                                    document.getElementById('removePartTicketId').value = '';
                                    document.getElementById('removePartInventoryId').value = '';

                                    // Refresh tickets list and ensure it's visible so the parts update is shown
                                    try {
                                        await getAllTickets(false);
                                    } catch (e) {
                                        console.warn('Failed to refresh tickets after removing part:', e);
                                    }
                                    ticketsVisible = true;
                                    const tbtn = document.getElementById('toggle-tickets-btn');
                                    if (tbtn) tbtn.textContent = 'Hide';
                                    if (domElements && domElements.ticketsList) domElements.ticketsList.style.display = '';
                            } catch (error) {
                                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                            }
                        }
                // Toggle inventory list visibility and fetch if needed
                        // Add part to service ticket
                        async function addPartToTicket() {
                            const resultDiv = document.getElementById('add-part-to-ticket-result');
                            const ticketId = document.getElementById('addPartTicketId').value;
                            const partId = document.getElementById('addPartInventoryId').value;
                            if (!ticketId || !partId) {
                                resultDiv.innerHTML = '<div class="error">Please enter both Ticket ID and Part ID!</div>';
                                return;
                            }
                            resultDiv.innerHTML = '<div class="loading">Adding part to ticket...</div>';
                            try {
                                const response = await fetch(`${getApiUrl()}/service-tickets/${ticketId}/add-part/${partId}`, {
                                    method: 'PUT'
                                });
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                const data = await response.json();
                                console.log('addPart response:', data);
                                resultDiv.innerHTML = `<div class="success">‚úÖ Part added to ticket!</div>`;
                                document.getElementById('addPartTicketId').value = '';
                                document.getElementById('addPartInventoryId').value = '';

                                // Refresh tickets list and ensure it's visible so the parts update is shown
                                try {
                                    await getAllTickets(false);
                                } catch (e) {
                                    console.warn('Failed to refresh tickets after adding part:', e);
                                }
                                ticketsVisible = true;
                                const tbtn = document.getElementById('toggle-tickets-btn');
                                if (tbtn) tbtn.textContent = 'Hide';
                                if (domElements && domElements.ticketsList) domElements.ticketsList.style.display = '';
                            } catch (error) {
                                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                            }
                        }
                let inventoryVisible = false;
                async function toggleInventoryList() {
                    const btn = document.getElementById('toggle-inventory-btn');
                    const list = domElements.inventoryList;
                    if (!inventoryVisible) {
                        // Show and fetch
                        btn.textContent = 'Hide';
                        list.style.display = '';
                        await getAllInventory();
                        inventoryVisible = true;
                    } else {
                        // Hide
                        btn.textContent = 'Get All Items';
                        list.style.display = 'none';
                        inventoryVisible = false;
                    }
                }

                // Toggle customers list visibility and fetch if needed
                let customersVisible = false;
                async function toggleCustomersList() {
                    const btn = document.getElementById('toggle-customers-btn');
                    const list = domElements.customersList;
                    if (!customersVisible) {
                        // Show and fetch
                        btn.textContent = 'Hide';
                        list.style.display = '';
                        await getAllCustomers();
                        customersVisible = true;
                    } else {
                        // Hide
                        btn.textContent = 'Get All Customers';
                        list.style.display = 'none';
                        customersVisible = false;
                    }
                }

                // Toggle mechanics list visibility and fetch if needed
                let mechanicsVisible = false;
                async function toggleMechanicsList() {
                    const btn = document.getElementById('toggle-mechanics-btn');
                    const list = domElements.mechanicsList;
                    if (!mechanicsVisible) {
                        // Show and fetch
                        btn.textContent = 'Hide';
                        list.style.display = '';
                        await getAllMechanics();
                        mechanicsVisible = true;
                    } else {
                        // Hide
                        btn.textContent = 'Get All Mechanics';
                        list.style.display = 'none';
                        mechanicsVisible = false;
                    }
                }

                // Toggle tickets list visibility and fetch if needed
                let ticketsVisible = false;
                async function toggleTicketsList() {
                    const btn = document.getElementById('toggle-tickets-btn');
                    const list = domElements.ticketsList;
                    if (!ticketsVisible) {
                        // Show and fetch
                        btn.textContent = 'Hide';
                        list.style.display = '';
                        await getAllTickets();
                        ticketsVisible = true;
                    } else {
                        // Hide
                        btn.textContent = 'Get All Tickets';
                        list.style.display = 'none';
                        ticketsVisible = false;
                    }
                }
        // ===== PRELOAD VARIABLES =====
        const preloadedData = {
            customers: null,
            mechanics: null,
            inventory: null,
            tickets: null
        };

        // ===== CACHE DOM ELEMENTS =====
        const domElements = {
            customersList: document.getElementById('customers-list'),
            mechanicsList: document.getElementById('mechanics-list'),
            inventoryList: document.getElementById('inventory-list'),
            ticketsList: document.getElementById('tickets-list')
        };

        // ===== GENERIC GET ALL FUNCTION =====
        async function getAllData(type, usePreload = true) {
            const resultDiv = domElements[`${type}List`];
            resultDiv.innerHTML = '<div class="loading">Loading...</div>';
            let data = null;
            try {
                if (usePreload && preloadedData[type]) {
                    data = preloadedData[type];
                } else {
                    const response = await fetch(`${getApiUrl()}/${type === 'tickets' ? 'service-tickets' : type}/?_=${Date.now()}`);
                    data = await parseResponse(response, `retrieving all ${type}`);
                    preloadedData[type] = data;
                }
                if (!data || data.length === 0) {
                    resultDiv.innerHTML = '<div class="error">No data found.</div>';
                    return;
                }
                const refreshButton = `<button onclick="refreshData('${type}')" class="refresh-btn">üîÑ Refresh</button>`;
                const html = refreshButton + renderDataList(type, data);
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // ===== RENDER DATA LIST =====
        function renderDataList(type, data) {
            const renderers = {
                customers: (item) => `<div class="data-card">
                    <h3>${item.first_name} ${item.last_name}</h3>
                    <p><b>ID:</b> ${item.id}</p>
                    <p><b>Email:</b> ${item.email}</p>
                    <p><b>Phone:</b> ${item.phone || ''}</p>
                    <p><b>Address:</b> ${item.address || ''}</p>
                </div>`,
                mechanics: (item) => `<div class="data-card">
                    <h3>${item.first_name} ${item.last_name}</h3>
                    <p><b>ID:</b> ${item.id}</p>
                    <p><b>Email:</b> ${item.email}</p>
                    <p><b>Phone:</b> ${item.phone || ''}</p>
                    <p><b>Specialty:</b> ${item.specialty || ''}</p>
                    <p><b>Hourly Rate:</b> $${item.hourly_rate || ''}</p>
                    <p><b>Hire Date:</b> ${item.hire_date || ''}</p>
                </div>`,
                inventory: (item) => `<div class="data-card">
                    <h3>${item.name}</h3>
                    <p><b>ID:</b> ${item.id}</p>
                    <p><b>Price:</b> $${item.price}</p>
                </div>`,
                tickets: (item) => {
                    const vehicleInfo = item.vehicle_year || item.vehicle_make || item.vehicle_model
                        ? `${item.vehicle_year || ''} ${item.vehicle_make || ''} ${item.vehicle_model || ''}`.trim()
                        : 'Not specified';
                    const customerName = item.customer 
                        ? `${item.customer.first_name} ${item.customer.last_name}`
                        : `Customer ID: ${item.customer_id}`;
                    const mechanicsList = item.mechanics && item.mechanics.length > 0
                        ? item.mechanics.map(m => `${m.first_name} ${m.last_name}`).join(', ')
                        : 'Not assigned';
                    const dateCreated = item.created_at 
                        ? new Date(item.created_at).toLocaleDateString()
                        : 'Unknown';
                    // Parts rendering
                    let partsHtml = '';
                    if (item.parts && Array.isArray(item.parts) && item.parts.length > 0) {
                        partsHtml = `<p><b>Parts:</b> ` + item.parts.map(p => `${p.name || p.part_name || 'Part'} (ID: ${p.id}${p.quantity ? ', Qty: ' + p.quantity : ''})`).join(', ') + `</p>`;
                    } else if (item.inventory && Array.isArray(item.inventory) && item.inventory.length > 0) {
                        partsHtml = `<p><b>Parts:</b> ` + item.inventory.map(p => `${p.name || p.part_name || 'Part'} (ID: ${p.id}${p.quantity ? ', Qty: ' + p.quantity : ''})`).join(', ') + `</p>`;
                    }
                    return `<div class="data-card">
                        <h3>Ticket #${item.id}</h3>
                        <p><b>Vehicle:</b> ${vehicleInfo}</p>
                        ${item.vehicle_vin ? `<p><b>VIN:</b> ${item.vehicle_vin}</p>` : ''}
                        <p><b>Description:</b> ${item.description}</p>
                        <p><b>Created:</b> ${dateCreated}</p>
                        <p><b>Status:</b> ${item.status || 'Open'}</p>
                        <p><b>Customer:</b> ${customerName}</p>
                        <p><b>Mechanic(s):</b> ${mechanicsList}</p>
                        ${partsHtml}
                        ${item.estimated_cost ? `<p><b>Estimated Cost:</b> $${item.estimated_cost.toFixed(2)}</p>` : ''}
                        ${item.actual_cost ? `<p><b>Actual Cost:</b> $${item.actual_cost.toFixed(2)}</p>` : ''}
                    </div>`;
                }
            };
            return data.map(renderers[type]).join('');
        }

        // ===== REFRESH DATA =====
        async function refreshData(type) {
            preloadedData[type] = null;
            await getAllData(type, false);
        }

        // ===== PRELOAD ALL DATA ON PAGE LOAD =====
        async function preloadAllData() {
            try {
                const [customers, mechanics, inventory, tickets] = await Promise.all([
                    fetch(`${getApiUrl()}/customers/?_=${Date.now()}`).then(res => parseResponse(res, 'preloading customers')),
                    fetch(`${getApiUrl()}/mechanics/?_=${Date.now()}`).then(res => parseResponse(res, 'preloading mechanics')),
                    fetch(`${getApiUrl()}/inventory/?_=${Date.now()}`).then(res => parseResponse(res, 'preloading inventory')),
                    fetch(`${getApiUrl()}/service-tickets/?_=${Date.now()}`).then(res => parseResponse(res, 'preloading service tickets'))
                ]);
                preloadedData.customers = customers;
                preloadedData.mechanics = mechanics;
                preloadedData.inventory = inventory;
                preloadedData.tickets = tickets;
                console.log('All data preloaded successfully');
            } catch (error) {
                console.error('Error preloading data:', error);
                // Continue without preloaded data
            }
        }

        // Call preload on page load
        window.addEventListener('load', preloadAllData);
        // API base URL (hardcoded)
        const API_URL = 'https://mechanic-api-copy-with-testing-and.onrender.com';
        let authToken = null;
        let loggedInCustomer = null;
        
        function getApiUrl() {
            return API_URL;
        }

        // Parse fetch responses and produce rich errors for UI (handles 404, 308, etc.)
        async function parseResponse(response, context = '') {
            const text = await response.text();
            let data = null;
            try { data = text ? JSON.parse(text) : null; } catch { data = text; }

            if (!response.ok) {
                let message = `HTTP ${response.status} ${response.statusText}`;
                if (response.status === 404) {
                    message += ` ‚Äî Not Found. ${context} The requested resource doesn't exist or the ID/URL is incorrect.`;
                } else if (response.status === 308) {
                    message += ` ‚Äî Permanent Redirect. The server is redirecting (likely the endpoint expects a trailing slash). Use the correct endpoint URL with a trailing slash.`;
                } else if (response.status === 409) {
                    message += ` ‚Äî Conflict. ${data && data.error ? data.error : ''}`;
                }
                if (data) {
                    try {
                        const extra = typeof data === 'string' ? data : (data.error || JSON.stringify(data));
                        if (extra) message += ` Response: ${extra}`;
                    } catch (e) {}
                }

                const err = new Error(message);
                err.status = response.status;
                err.response = data;
                throw err;
            }

            return data;
        }

        function updateAuthStatus() {
            const authMessage = document.getElementById('auth-message');
            const authRequiredSections = document.querySelectorAll('.auth-required');
            
            if (authToken && loggedInCustomer) {
                authMessage.innerHTML = `üîê Logged in as: ${loggedInCustomer.email}`;
                authMessage.style.background = '#e0ffe0';
                
                // Show auth-required sections
                authRequiredSections.forEach(section => {
                    section.classList.add('logged-in');
                });
                
                // Auto-fill customer ID in update and delete forms
                document.getElementById('updateCustomerId').value = loggedInCustomer.id;
                document.getElementById('deleteCustomerId').value = loggedInCustomer.id;
            } else {
                authMessage.innerHTML = 'üîì Not logged in';
                authMessage.style.background = '#f0f0f0';
                
                // Hide auth-required sections
                authRequiredSections.forEach(section => {
                    section.classList.remove('logged-in');
                });
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // ===== AUTHENTICATION FUNCTIONS =====
        async function login() {
            const resultDiv = document.getElementById('login-result');
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                resultDiv.innerHTML = '<div class="error">Please enter email and password!</div>';
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/customers/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await parseResponse(response, 'retrieving customers');
                authToken = data.token;
                loggedInCustomer = data.customer;
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Login successful!<br>Customer: ${data.customer.first_name} ${data.customer.last_name}</div>`;
                updateAuthStatus();
                
                // Clear form
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Login failed: ${error.message}</div>`;
            }
        }

        function logout() {
            authToken = null;
            loggedInCustomer = null;
            updateAuthStatus();
            const resultDiv = document.getElementById('login-result');
            resultDiv.innerHTML = '<div class="success">üëã Logged out successfully</div>';
        }

        async function getMyTickets() {
            const resultDiv = document.getElementById('my-tickets-list');
            
            if (!authToken) {
                resultDiv.innerHTML = '<div class="error">Please login first!</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Loading your tickets...</div>';
            
            try {
                const response = await fetch(`${getApiUrl()}/customers/my-tickets`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await parseResponse(response, 'fetching login result');
                
                if (data.length === 0) {
                    resultDiv.innerHTML = '<p>No tickets found.</p>';
                    return;
                }
                
                let html = '';
                data.forEach(ticket => {
                    const vehicleInfo = ticket.vehicle_year || ticket.vehicle_make || ticket.vehicle_model
                        ? `${ticket.vehicle_year || ''} ${ticket.vehicle_make || ''} ${ticket.vehicle_model || ''}`.trim()
                        : 'Not specified';
                    
                    html += `
                        <div class="data-card">
                            <h3>Ticket #${ticket.id}</h3>
                            <p><b>Vehicle:</b> ${vehicleInfo}</p>
                            <p><b>Description:</b> ${ticket.description}</p>
                            <p><b>Status:</b> ${ticket.status || 'Open'}</p>
                            ${ticket.estimated_cost ? `<p><b>Estimated Cost:</b> $${ticket.estimated_cost.toFixed(2)}</p>` : ''}
                            ${ticket.actual_cost ? `<p><b>Actual Cost:</b> $${ticket.actual_cost.toFixed(2)}</p>` : ''}
                        </div>
                    `;
                });
                
                resultDiv.style.display = '';
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // ===== CUSTOMER FUNCTIONS =====
        // ===== REFACTORED: GET ALL CUSTOMERS (PRELOAD + REFRESH) =====
        async function getAllCustomers(usePreload = true) {
            await getAllData('customers', usePreload);
        }
        async function refreshCustomers() {
            await refreshData('customers');
        }

        async function addCustomer() {
            const resultDiv = document.getElementById('add-customer-result');
            const firstName = document.getElementById('customerFirstName').value;
            const lastName = document.getElementById('customerLastName').value;
            const email = document.getElementById('customerEmail').value;
            const password = document.getElementById('customerPassword').value;
            const phone = document.getElementById('customerPhone').value;
            const address = document.getElementById('customerAddress').value;
            
            if (!firstName || !lastName || !email || !password) {
                resultDiv.innerHTML = '<div class="error">Please fill in all required fields!</div>';
                return;
            }
            
            const customerData = {
                first_name: firstName,
                last_name: lastName,
                email: email,
                password: password
            };
            
            if (phone) customerData.phone = phone;
            if (address) customerData.address = address;
            
            try {
                const response = await fetch(`${getApiUrl()}/customers/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(customerData)
                });
                
                const data = await parseResponse(response, 'retrieving mechanics');
                resultDiv.innerHTML = `<div class="success">Customer added successfully! ID: ${data.id}</div>`;
                
                // Clear form
                document.getElementById('customerFirstName').value = '';
                document.getElementById('customerLastName').value = '';
                document.getElementById('customerEmail').value = '';
                document.getElementById('customerPassword').value = '';
                document.getElementById('customerPhone').value = '';
                document.getElementById('customerAddress').value = '';
                
                // Refresh customer list
                setTimeout(() => refreshCustomers(), 1000);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // ===== MECHANIC FUNCTIONS =====
        // ===== REFACTORED: GET ALL MECHANICS (PRELOAD + REFRESH) =====
        async function getAllMechanics(usePreload = true) {
            await getAllData('mechanics', usePreload);
        }
        async function refreshMechanics() {
            await refreshData('mechanics');
        }

        async function addMechanic() {
            const resultDiv = document.getElementById('add-mechanic-result');
            const firstName = document.getElementById('mechanicFirstName').value;
            const lastName = document.getElementById('mechanicLastName').value;
            const email = document.getElementById('mechanicEmail').value;
            const phone = document.getElementById('mechanicPhone').value;
            const specialty = document.getElementById('mechanicSpecialty').value;
            const hourlyRate = document.getElementById('mechanicHourlyRate').value;
            const hireDate = document.getElementById('mechanicHireDate') ? document.getElementById('mechanicHireDate').value : '';
            
            if (!firstName || !lastName || !email) {
                resultDiv.innerHTML = '<div class="error">Please fill in all required fields!</div>';
                return;
            }
            
            const mechanicData = {
                first_name: firstName,
                last_name: lastName,
                email: email
            };
            
            if (phone) mechanicData.phone = phone;
            if (specialty) mechanicData.specialty = specialty;
            if (hourlyRate) mechanicData.hourly_rate = parseFloat(hourlyRate);
            if (hireDate) mechanicData.hire_date = hireDate;
            
            try {
                const response = await fetch(`${getApiUrl()}/mechanics/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(mechanicData)
                });
                
                const data = await parseResponse(response, 'getting mechanic by id');
                resultDiv.innerHTML = `<div class="success">Mechanic added successfully! ID: ${data.id}</div>`;
                
                // Clear form
                document.getElementById('mechanicFirstName').value = '';
                document.getElementById('mechanicLastName').value = '';
                document.getElementById('mechanicEmail').value = '';
                document.getElementById('mechanicPhone').value = '';
                document.getElementById('mechanicSpecialty').value = '';
                document.getElementById('mechanicHourlyRate').value = '';
                document.getElementById('mechanicHireDate').value = '';
                
                // Refresh mechanic list
                setTimeout(() => refreshMechanics(), 1000);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // ===== INVENTORY FUNCTIONS =====
        // ===== REFACTORED: GET ALL INVENTORY (PRELOAD + REFRESH) =====
        async function getAllInventory(usePreload = true) {
            await getAllData('inventory', usePreload);
        }
        async function refreshInventory() {
            await refreshData('inventory');
        }

        // ===== SERVICE TICKET FUNCTIONS =====
        // ===== REFACTORED: GET ALL TICKETS (PRELOAD + REFRESH) =====
        async function getAllTickets(usePreload = true) {
            await getAllData('tickets', usePreload);
        }
        async function refreshTickets() {
            await refreshData('tickets');
        }

        // Additional Customer Functions
        async function getCustomerById() {
            const resultDiv = document.getElementById('get-customer-result');
            const customerId = document.getElementById('getCustomerId').value;
            
            if (!customerId) {
                resultDiv.innerHTML = '<div class="error">Please enter a customer ID!</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Loading customer...</div>';
            
            try {
                const response = await fetch(`${getApiUrl()}/customers/${customerId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const customer = await response.json();
                
                resultDiv.style.display = '';
                resultDiv.innerHTML = `
                    <div class="data-card">
                        <h3>${customer.first_name} ${customer.last_name}</h3>
                        <p><b>ID:</b> ${customer.id}</p>
                        <p><b>Email:</b> ${customer.email}</p>
                        <p><b>Phone:</b> ${customer.phone || ''}</p>
                        <p><b>Address:</b> ${customer.address || ''}</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function updateCustomer() {
            const resultDiv = document.getElementById('update-customer-result');
            
            if (!authToken) {
                resultDiv.innerHTML = '<div class="error">Please login first!</div>';
                return;
            }
            
            const customerId = document.getElementById('updateCustomerId').value;
            const firstName = document.getElementById('updateCustomerFirstName').value;
            const lastName = document.getElementById('updateCustomerLastName').value;
            const email = document.getElementById('updateCustomerEmail').value;
            const password = document.getElementById('updateCustomerPassword') ? document.getElementById('updateCustomerPassword').value : '';
            const phone = document.getElementById('updateCustomerPhone').value;
            const address = document.getElementById('updateCustomerAddress').value;
            
            if (!customerId) {
                resultDiv.innerHTML = '<div class="error">Please enter a customer ID!</div>';
                return;
            }
            
            const updateData = {};
            if (firstName) updateData.first_name = firstName;
            if (lastName) updateData.last_name = lastName;
            if (email) updateData.email = email;
            if (password) updateData.password = password;
            if (phone) updateData.phone = phone;
            if (address) updateData.address = address;
            
            if (Object.keys(updateData).length === 0) {
                resultDiv.innerHTML = '<div class="error">Please enter at least one field to update!</div>';
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/customers/${customerId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(updateData)
                });
                
                const data = await parseResponse(response, 'creating inventory item');
                resultDiv.innerHTML = `<div class="success">‚úÖ Customer updated successfully!</div>`;
                
                // Clear form
                document.getElementById('updateCustomerId').value = '';
                document.getElementById('updateCustomerFirstName').value = '';
                document.getElementById('updateCustomerLastName').value = '';
                document.getElementById('updateCustomerEmail').value = '';
                document.getElementById('updateCustomerPassword').value = '';
                document.getElementById('updateCustomerPhone').value = '';
                document.getElementById('updateCustomerAddress').value = '';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function deleteCustomer() {
            const resultDiv = document.getElementById('delete-customer-result');
            
            if (!authToken) {
                resultDiv.innerHTML = '<div class="error">Please login first!</div>';
                return;
            }
            
            const customerId = document.getElementById('deleteCustomerId').value;
            
            if (!customerId) {
                resultDiv.innerHTML = '<div class="error">Please enter a customer ID!</div>';
                return;
            }
            
            if (!confirm(`Are you sure you want to delete customer ${customerId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/customers/${customerId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.status === 409) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Cannot delete customer!<br>${data.error || 'Customer has associated service tickets.'}<br><br>üí° Tip: Delete the customer's service tickets first.</div>`;
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Customer deleted successfully!</div>`;
                document.getElementById('deleteCustomerId').value = '';
                
                // Refresh customer list if visible
                setTimeout(() => refreshCustomers(), 500);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Additional Mechanic Functions
        async function getMechanicById() {
            const resultDiv = document.getElementById('get-mechanic-result');
            const mechanicId = document.getElementById('getMechanicId').value;
            
            if (!mechanicId) {
                resultDiv.innerHTML = '<div class="error">Please enter a mechanic ID!</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Loading mechanic...</div>';
            
            try {
                const response = await fetch(`${getApiUrl()}/mechanics/${mechanicId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const mechanic = await response.json();
                
                resultDiv.style.display = '';
                resultDiv.innerHTML = `
                    <div class="data-card">
                        <h3>${mechanic.first_name} ${mechanic.last_name}</h3>
                        <p><b>ID:</b> ${mechanic.id}</p>
                        <p><b>Email:</b> ${mechanic.email}</p>
                        <p><b>Phone:</b> ${mechanic.phone || ''}</p>
                        <p><b>Specialty:</b> ${mechanic.specialty || ''}</p>
                        <p><b>Hourly Rate:</b> $${mechanic.hourly_rate || ''}</p>
                        <p><b>Hire Date:</b> ${mechanic.hire_date || ''}</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function updateMechanic() {
            const resultDiv = document.getElementById('update-mechanic-result');
            const mechanicId = document.getElementById('updateMechanicId').value;
            const firstName = document.getElementById('updateMechanicFirstName').value;
            const lastName = document.getElementById('updateMechanicLastName').value;
            const email = document.getElementById('updateMechanicEmail').value;
            const phone = document.getElementById('updateMechanicPhone').value;
            const specialty = document.getElementById('updateMechanicSpecialty').value;
            const hourlyRate = document.getElementById('updateMechanicHourlyRate').value;
            const hireDate = document.getElementById('updateMechanicHireDate') ? document.getElementById('updateMechanicHireDate').value : '';
            
            if (!mechanicId) {
                resultDiv.innerHTML = '<div class="error">Please enter a mechanic ID!</div>';
                return;
            }
            
            const updateData = {};
            if (firstName) updateData.first_name = firstName;
            if (lastName) updateData.last_name = lastName;
            if (email) updateData.email = email;
            if (phone) updateData.phone = phone;
            if (specialty) updateData.specialty = specialty;
            if (hourlyRate) updateData.hourly_rate = parseFloat(hourlyRate);
            if (hireDate) updateData.hire_date = hireDate;
            
            if (Object.keys(updateData).length === 0) {
                resultDiv.innerHTML = '<div class="error">Please enter at least one field to update!</div>';
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/mechanics/${mechanicId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Mechanic updated successfully!</div>`;
                
                // Clear form
                document.getElementById('updateMechanicId').value = '';
                document.getElementById('updateMechanicFirstName').value = '';
                document.getElementById('updateMechanicLastName').value = '';
                document.getElementById('updateMechanicEmail').value = '';
                document.getElementById('updateMechanicPhone').value = '';
                document.getElementById('updateMechanicSpecialty').value = '';
                document.getElementById('updateMechanicHourlyRate').value = '';
                document.getElementById('updateMechanicHireDate').value = '';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function deleteMechanic() {
            const resultDiv = document.getElementById('delete-mechanic-result');
            const mechanicId = document.getElementById('deleteMechanicId').value;
            
            if (!mechanicId) {
                resultDiv.innerHTML = '<div class="error">Please enter a mechanic ID!</div>';
                return;
            }
            
            if (!confirm(`Are you sure you want to delete mechanic ${mechanicId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/mechanics/${mechanicId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.status === 409) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Cannot delete mechanic!<br>${data.error || 'Mechanic is assigned to service tickets.'}<br><br>üí° Tip: Remove the mechanic from all service tickets first.</div>`;
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Mechanic deleted successfully!</div>`;
                document.getElementById('deleteMechanicId').value = '';
                
                // Refresh mechanic list if visible
                setTimeout(() => refreshMechanics(), 500);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Additional Inventory Functions
        async function addInventoryItem() {
            const resultDiv = document.getElementById('add-inventory-result');
            const partName = document.getElementById('inventoryPartName').value;
            const price = document.getElementById('inventoryPrice').value;
            
            if (!partName || !price) {
                resultDiv.innerHTML = '<div class="error">Please fill in all fields!</div>';
                return;
            }
            
            try {
                const body = {
                    name: partName,
                    price: parseFloat(price)
                };

                const response = await fetch(`${getApiUrl()}/inventory/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                const data = await parseResponse(response, 'adding inventory item');
                resultDiv.innerHTML = `<div class="success">‚úÖ Inventory item added! ID: ${data.id}</div>`;

                // Clear form
                document.getElementById('inventoryPartName').value = '';
                document.getElementById('inventoryPrice').value = '';

                // Refresh inventory list
                setTimeout(() => refreshInventory(), 500);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function getInventoryById() {
            const resultDiv = document.getElementById('get-inventory-result');
            const inventoryId = document.getElementById('getInventoryId').value;
            
            if (!inventoryId) {
                resultDiv.innerHTML = '<div class="error">Please enter an inventory ID!</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Loading inventory item...</div>';
            
            try {
                const response = await fetch(`${getApiUrl()}/inventory/${inventoryId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const item = await response.json();
                let ticketsHtml = '';
                // Try to find related tickets in the response
                let tickets = [];
                if (item.tickets && Array.isArray(item.tickets)) {
                    tickets = item.tickets;
                } else if (item.service_tickets && Array.isArray(item.service_tickets)) {
                    tickets = item.service_tickets;
                }
                if (tickets.length > 0) {
                    ticketsHtml = `<div style='margin-top:1em;'><b>Used in Tickets:</b><ul style='margin:0 0 0 1em;'>` +
                        tickets.map(t => `<li>Ticket #${t.id}: ${t.description ? t.description : ''}</li>`).join('') +
                        `</ul></div>`;
                }
                resultDiv.style.display = '';
                resultDiv.innerHTML = `
                    <div class="data-card">
                        <h3>${item.name || item.part_name}</h3>
                        <p><b>ID:</b> ${item.id}</p>
                        <p><b>Price:</b> $${item.price}</p>
                        <p><b>Quantity:</b> ${item.quantity}</p>
                        ${item.sku ? `<p><b>SKU:</b> ${item.sku}</p>` : ''}
                        ${item.supplier ? `<p><b>Supplier:</b> ${item.supplier}</p>` : ''}
                        ${item.description ? `<p><b>Description:</b> ${item.description}</p>` : ''}
                        ${ticketsHtml}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function updateInventoryItem() {
            const resultDiv = document.getElementById('update-inventory-result');
            const inventoryId = document.getElementById('updateInventoryId').value;
            const partName = document.getElementById('updateInventoryPartName').value;
            const price = document.getElementById('updateInventoryPrice').value;
            
            if (!inventoryId) {
                resultDiv.innerHTML = '<div class="error">Please enter an inventory ID!</div>';
                return;
            }
            
            const updateData = {};
            if (partName) updateData.name = partName;
            if (price) updateData.price = parseFloat(price);
            
            if (Object.keys(updateData).length === 0) {
                resultDiv.innerHTML = '<div class="error">Please enter at least one field to update!</div>';
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/inventory/${inventoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Inventory item updated!</div>`;
                
                // Clear form
                document.getElementById('updateInventoryId').value = '';
                document.getElementById('updateInventoryPartName').value = '';
                document.getElementById('updateInventoryPrice').value = '';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function deleteInventoryItem() {
            const resultDiv = document.getElementById('delete-inventory-result');
            const inventoryId = document.getElementById('deleteInventoryId').value;
            
            if (!inventoryId) {
                resultDiv.innerHTML = '<div class="error">Please enter an inventory ID!</div>';
                return;
            }
            
            if (!confirm(`Are you sure you want to delete inventory item ${inventoryId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/inventory/${inventoryId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.status === 409) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Cannot delete inventory item!<br>${data.error || 'Item is associated with service tickets.'}<br><br>üí° Tip: Remove this part from service tickets first.</div>`;
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Inventory item deleted!</div>`;
                document.getElementById('deleteInventoryId').value = '';
                
                // Refresh inventory list
                setTimeout(() => refreshInventory(), 500);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Additional Service Ticket Functions
        async function createServiceTicket() {
            const resultDiv = document.getElementById('create-ticket-result');
            const customerId = document.getElementById('ticketCustomerId').value;
            const description = document.getElementById('ticketDescription').value;
            const vehicleYear = document.getElementById('ticketVehicleYear').value;
            const vehicleMake = document.getElementById('ticketVehicleMake').value;
            const vehicleModel = document.getElementById('ticketVehicleModel').value;
            const vehicleVin = document.getElementById('ticketVehicleVin').value;
            const mechanicId = document.getElementById('ticketMechanicId') ? document.getElementById('ticketMechanicId').value : '';
            const estimatedCost = document.getElementById('ticketEstimatedCost').value;
            const status = document.getElementById('ticketStatus').value;
            
            if (!customerId || !description) {
                resultDiv.innerHTML = '<div class="error">Please enter customer ID and description!</div>';
                return;
            }
            
            const ticketData = {
                customer_id: parseInt(customerId),
                description: description,
                status: status
            };
            
            if (vehicleYear) ticketData.vehicle_year = parseInt(vehicleYear);
            if (vehicleMake) ticketData.vehicle_make = vehicleMake;
            if (vehicleModel) ticketData.vehicle_model = vehicleModel;
            if (vehicleVin) ticketData.vehicle_vin = vehicleVin;
            if (mechanicId) ticketData.mechanic_id = parseInt(mechanicId);
            if (estimatedCost) ticketData.estimated_cost = parseFloat(estimatedCost);
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ticketData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                resultDiv.innerHTML = `<div class="success">‚úÖ Service ticket created! ID: ${data.id}</div>`;
                
                // Clear form
                document.getElementById('ticketCustomerId').value = '';
                document.getElementById('ticketDescription').value = '';
                document.getElementById('ticketVehicleYear').value = '';
                document.getElementById('ticketVehicleMake').value = '';
                document.getElementById('ticketVehicleModel').value = '';
                document.getElementById('ticketVehicleVin').value = '';
                document.getElementById('ticketEstimatedCost').value = '';
                document.getElementById('ticketStatus').value = 'Open';
                
                // Refresh ticket list
                setTimeout(() => refreshTickets(), 500);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function getTicketById() {
            const resultDiv = document.getElementById('get-ticket-result');
            const ticketId = document.getElementById('getTicketId').value;
            
            if (!ticketId) {
                resultDiv.innerHTML = '<div class="error">Please enter a ticket ID!</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Loading ticket...</div>';
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/${ticketId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const ticket = await response.json();
                const vehicleInfo = ticket.vehicle_year || ticket.vehicle_make || ticket.vehicle_model
                    ? `${ticket.vehicle_year || ''} ${ticket.vehicle_make || ''} ${ticket.vehicle_model || ''}`.trim()
                    : 'Not specified';
                const customerName = ticket.customer 
                    ? `${ticket.customer.first_name} ${ticket.customer.last_name}`
                    : `Customer ID: ${ticket.customer_id}`;
                const mechanicsList = ticket.mechanics && ticket.mechanics.length > 0
                    ? ticket.mechanics.map(m => `${m.first_name} ${m.last_name}`).join(', ')
                    : 'Not assigned';
                // Parts rendering
                let partsHtml = '';
                if (ticket.parts && Array.isArray(ticket.parts) && ticket.parts.length > 0) {
                    partsHtml = `<p><b>Parts:</b> ` + ticket.parts.map(p => `${p.name || p.part_name || 'Part'} (ID: ${p.id}${p.quantity ? ', Qty: ' + p.quantity : ''})`).join(', ') + `</p>`;
                } else if (ticket.inventory && Array.isArray(ticket.inventory) && ticket.inventory.length > 0) {
                    partsHtml = `<p><b>Parts:</b> ` + ticket.inventory.map(p => `${p.name || p.part_name || 'Part'} (ID: ${p.id}${p.quantity ? ', Qty: ' + p.quantity : ''})`).join(', ') + `</p>`;
                }
                resultDiv.style.display = '';
                resultDiv.innerHTML = `
                    <div class="data-card">
                        <h3>Ticket #${ticket.id}</h3>
                        <p><b>Vehicle:</b> ${vehicleInfo}</p>
                        ${ticket.vehicle_vin ? `<p><b>VIN:</b> ${ticket.vehicle_vin}</p>` : ''}
                        <p><b>Description:</b> ${ticket.description}</p>
                        <p><b>Status:</b> ${ticket.status || 'Open'}</p>
                        <p><b>Customer:</b> ${customerName}</p>
                        <p><b>Mechanic(s):</b> ${mechanicsList}</p>
                        ${partsHtml}
                        ${ticket.estimated_cost ? `<p><b>Estimated Cost:</b> $${ticket.estimated_cost.toFixed(2)}</p>` : ''}
                        ${ticket.actual_cost ? `<p><b>Actual Cost:</b> $${ticket.actual_cost.toFixed(2)}</p>` : ''}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function updateServiceTicket() {
            const resultDiv = document.getElementById('update-ticket-result');
            const ticketId = document.getElementById('updateTicketId').value;
            const description = document.getElementById('updateTicketDescription').value;
            const actualCost = document.getElementById('updateTicketActualCost').value;
            const status = document.getElementById('updateTicketStatus').value;
            const vehicleYear = document.getElementById('updateTicketVehicleYear').value;
            const vehicleMake = document.getElementById('updateTicketVehicleMake').value;
            const vehicleModel = document.getElementById('updateTicketVehicleModel').value;
            const vehicleVin = document.getElementById('updateTicketVehicleVin').value;
            const estimatedCost = document.getElementById('updateTicketEstimatedCost').value;
            
            if (!ticketId) {
                resultDiv.innerHTML = '<div class="error">Please enter a ticket ID!</div>';
                return;
            }
            
            const updateData = {};
            if (description) updateData.description = description;
            if (actualCost) updateData.actual_cost = parseFloat(actualCost);
            if (status) updateData.status = status;
            if (vehicleYear) updateData.vehicle_year = parseInt(vehicleYear);
            if (vehicleMake) updateData.vehicle_make = vehicleMake;
            if (vehicleModel) updateData.vehicle_model = vehicleModel;
            if (vehicleVin) updateData.vehicle_vin = vehicleVin;
            if (estimatedCost) updateData.estimated_cost = parseFloat(estimatedCost);
            
            if (Object.keys(updateData).length === 0) {
                resultDiv.innerHTML = '<div class="error">Please enter at least one field to update!</div>';
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/${ticketId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Service ticket updated!</div>`;
                
                // Clear form
                document.getElementById('updateTicketId').value = '';
                document.getElementById('updateTicketDescription').value = '';
                document.getElementById('updateTicketActualCost').value = '';
                document.getElementById('updateTicketStatus').value = '';
                document.getElementById('updateTicketVehicleYear').value = '';
                document.getElementById('updateTicketVehicleMake').value = '';
                document.getElementById('updateTicketVehicleModel').value = '';
                document.getElementById('updateTicketVehicleVin').value = '';
                document.getElementById('updateTicketEstimatedCost').value = '';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function deleteServiceTicket() {
            const resultDiv = document.getElementById('delete-ticket-result');
            const ticketId = document.getElementById('deleteTicketId').value;
            
            if (!ticketId) {
                resultDiv.innerHTML = '<div class="error">Please enter a ticket ID!</div>';
                return;
            }
            
            if (!confirm(`Are you sure you want to delete service ticket ${ticketId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/${ticketId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Service ticket deleted!</div>`;
                document.getElementById('deleteTicketId').value = '';
                
                // Refresh ticket list
                setTimeout(() => refreshTickets(), 500);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function assignMechanicToTicket() {
            const resultDiv = document.getElementById('assign-mechanic-result');
            const ticketId = document.getElementById('assignTicketId').value;
            const mechanicId = document.getElementById('assignMechanicId').value;
            
            if (!ticketId || !mechanicId) {
                resultDiv.innerHTML = '<div class="error">Please enter both ticket ID and mechanic ID!</div>';
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/${ticketId}/assign-mechanic/${mechanicId}`, {
                    method: 'PUT'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Mechanic assigned to ticket!</div>`;
                
                // Clear form
                document.getElementById('assignTicketId').value = '';
                document.getElementById('assignMechanicId').value = '';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function removeMechanicFromTicket() {
            const resultDiv = document.getElementById('remove-mechanic-result');
            const ticketId = document.getElementById('removeMechanicTicketId').value;
            const mechanicId = document.getElementById('removeMechanicId').value;
            
            if (!ticketId || !mechanicId) {
                resultDiv.innerHTML = '<div class="error">Please enter both ticket ID and mechanic ID!</div>';
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/${ticketId}/remove-mechanic/${mechanicId}`, {
                    method: 'PUT'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Mechanic removed from ticket!</div>`;
                
                // Clear form
                document.getElementById('removeMechanicTicketId').value = '';
                document.getElementById('removeMechanicId').value = '';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function getTicketsByCustomer() {
            const resultDiv = document.getElementById('tickets-by-customer-result');
            const customerId = document.getElementById('ticketsByCustomerId').value;
            
            if (!customerId) {
                resultDiv.innerHTML = '<div class="error">Please enter a customer ID!</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Loading customer tickets...</div>';
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/customer/${customerId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.length === 0) {
                    resultDiv.innerHTML = '<p>No tickets found for this customer.</p>';
                    return;
                }
                
                let html = '';
                data.forEach(ticket => {
                    const vehicleInfo = ticket.vehicle_year || ticket.vehicle_make || ticket.vehicle_model
                        ? `${ticket.vehicle_year || ''} ${ticket.vehicle_make || ''} ${ticket.vehicle_model || ''}`.trim()
                        : 'Not specified';
                    
                    html += `
                        <div class="data-card">
                            <h3>Ticket #${ticket.id}</h3>
                            <p><b>Vehicle:</b> ${vehicleInfo}</p>
                            <p><b>Description:</b> ${ticket.description}</p>
                            <p><b>Status:</b> ${ticket.status || 'Open'}</p>
                            ${ticket.estimated_cost ? `<p><b>Estimated Cost:</b> $${ticket.estimated_cost.toFixed(2)}</p>` : ''}
                        </div>
                    `;
                });
                
                resultDiv.style.display = '';
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function getTicketsByMechanic() {
            const resultDiv = document.getElementById('tickets-by-mechanic-result');
            const mechanicId = document.getElementById('ticketsByMechanicId').value;
            
            if (!mechanicId) {
                resultDiv.innerHTML = '<div class="error">Please enter a mechanic ID!</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Loading mechanic tickets...</div>';
            
            try {
                const response = await fetch(`${getApiUrl()}/service-tickets/mechanic/${mechanicId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.length === 0) {
                    resultDiv.innerHTML = '<p>No tickets found for this mechanic.</p>';
                    return;
                }
                
                let html = '';
                data.forEach(ticket => {
                    const vehicleInfo = ticket.vehicle_year || ticket.vehicle_make || ticket.vehicle_model
                        ? `${ticket.vehicle_year || ''} ${ticket.vehicle_make || ''} ${ticket.vehicle_model || ''}`.trim()
                        : 'Not specified';
                    
                    const customerName = ticket.customer 
                        ? `${ticket.customer.first_name} ${ticket.customer.last_name}`
                        : `Customer ID: ${ticket.customer_id}`;
                    
                    html += `
                        <div class="data-card">
                            <h3>Ticket #${ticket.id}</h3>
                            <p><b>Customer:</b> ${customerName}</p>
                            <p><b>Vehicle:</b> ${vehicleInfo}</p>
                            <p><b>Description:</b> ${ticket.description}</p>
                            <p><b>Status:</b> ${ticket.status || 'Open'}</p>
                            ${ticket.estimated_cost ? `<p><b>Estimated Cost:</b> $${ticket.estimated_cost.toFixed(2)}</p>` : ''}
                        </div>
                    `;
                });
                
                resultDiv.style.display = '';
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Initialize
        updateAuthStatus();
    </script>
</body>
</html>
